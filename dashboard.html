<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Contamination – Zones</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

body {
  background: #0a0018;
  color: #e1d8ff;
  font-family: 'Share Tech Mono', monospace;
  padding: 20px;
}

h1 {
  text-align: center;
  margin-bottom: 30px;
  color: #c8b4ff;
  text-shadow: 0 0 8px #7a5cff;
}

.zoneTitle {
  font-size: 1.8em;
  margin-top: 40px;
  margin-bottom: 15px;
  color: #ff9dff;
  text-shadow: 0 0 6px #b400ff;
}

#tagsA, #tagsB, #tagsC {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 20px;
}

.tagBox {
  width: 150px;
  padding: 12px;
  margin: 10px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 10px #000;
}

.state-sain {
  background: #2ecc71;
  box-shadow: 0 0 10px #2ecc71;
}

.state-contamine {
  background: #e74c3c;
  box-shadow: 0 0 10px #e74c3c;
}

.state-bloque {
  background: #3b0045;
  box-shadow: 0 0 12px #7a00a8;
}

.tagId {
  font-size: 1.4em;
  margin-bottom: 8px;
  color: #fff;
}

.smallInfo {
  font-size: 0.8em;
  margin-top: 4px;
  opacity: 0.9;
}
</style>
</head>

<body>

<h1>DASHBOARD – CONTAMINATION (Zones A / B / C)</h1>

<div class="zoneTitle">ZONE A</div>
<div id="tagsA"></div>

<div class="zoneTitle">ZONE B</div>
<div id="tagsB"></div>

<div class="zoneTitle">ZONE C</div>
<div id="tagsC"></div>

<script>
const binURL = "https://api.jsonbin.io/v3/b/6920c18ad0ea881f40f760fe/latest";
const apiKey = "$2a$10$FYbI.UBUR9uUn20mH5/nAesXEm4NPygH2n0HPRBlgSa8j/VmI8LD2";

const contA = document.getElementById("tagsA");
const contB = document.getElementById("tagsB");
const contC = document.getElementById("tagsC");

function msToMin(ms) {
  return Math.floor(ms / 60000);
}

async function load() {
  try {
    const res = await fetch(binURL, {
      headers: { "X-Master-Key": apiKey, "X-Bin-Meta": "false" }
    });

    const data = await res.json();
    const record = data.record || data;

    contA.innerHTML = "";
    contB.innerHTML = "";
    contC.innerHTML = "";

    for (const [id, info] of Object.entries(record)) {

      let state = info.state;
      let purifyCount = info.purifyCount;
      let contaminatedSince = info.contaminatedSince;

      if (state === "contamine" && contaminatedSince != null) {
        let diff = Date.now() - contaminatedSince;
        if (diff > 5 * 60000) {
          state = "bloque";
        }
      }

      const div = document.createElement("div");
      div.className = "tagBox state-" + state;

      div.innerHTML = `
        <div class="tagId">${id}</div>
        <div>État : <b>${state.toUpperCase()}</b></div>
        <div class="smallInfo">Purifications : ${purifyCount}/4</div>
        ${
          state === "contamine" && contaminatedSince
          ? `<div class="smallInfo">Contaminé depuis : ${msToMin(Date.now() - contaminatedSince)} min</div>`
          : ""
        }
      `;

      if (id.startsWith("A")) contA.appendChild(div);
      else if (id.startsWith("B")) contB.appendChild(div);
      else if (id.startsWith("C")) contC.appendChild(div);
    }

  } catch (err) {
    console.error("Erreur dashboard :", err);
  }
}

load();
setInterval(load, 3000);
</script>

</body>
</html>
