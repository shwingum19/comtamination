<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Contamination – V2</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

body {
  background: #0a0018;
  color: #e1d8ff;
  font-family: 'Share Tech Mono', monospace;
  text-align: center;
  padding: 20px;
}

h1 {
  font-size: 2em;
  margin-bottom: 20px;
  color: #c8b4ff;
  text-shadow: 0 0 8px #7a5cff;
}

#tagsContainer {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}

.tagBox {
  width: 150px;
  padding: 12px;
  margin: 10px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 10px #000;
}

.state-sain {
  background: #2ecc71;
  box-shadow: 0 0 10px #2ecc71;
}

.state-contamine {
  background: #e74c3c;
  box-shadow: 0 0 10px #e74c3c;
}

.state-bloque {
  background: #3b0045;
  box-shadow: 0 0 12px #7a00a8;
}

.tagId {
  font-size: 1.4em;
  margin-bottom: 8px;
  color: #fff;
}

.smallInfo {
  font-size: 0.8em;
  margin-top: 4px;
  opacity: 0.9;
}
</style>
</head>

<body>

<h1>DASHBOARD – CONTAMINATION V2</h1>
<div id="tagsContainer"></div>

<script>
const binURL = "https://api.jsonbin.io/v3/b/6922f02043b1c97be9bfcb3a/latest";
const apiKey = "$2a$10$FYbI.UBUR9uUn20mH5/nAesXEm4NPygH2n0HPRBlgSa8j/VmI8LD2";

const container = document.getElementById("tagsContainer");

function msToMin(ms) {
  return Math.floor(ms / 60000);
}

async function load() {
  try {
    const res = await fetch(binURL, {
      headers: {
        "X-Master-Key": apiKey,
        "X-Bin-Meta": "false"
      }
    });

    const data = await res.json();
    const record = data.record || data;

    container.innerHTML = "";

    for (const [id, info] of Object.entries(record)) {

      let state = info.state;
      let purifyCount = info.purifyCount;
      let contaminatedSince = info.contaminatedSince;

      // Vérification du blocage auto (>5 min)
      if (state === "contamine" && contaminatedSince != null) {
        let diff = Date.now() - contaminatedSince;
        if (diff > 5 * 60000) {
          state = "bloque";
        }
      }

      const div = document.createElement("div");
      div.className = "tagBox state-" + state;

      div.innerHTML = `
        <div class="tagId">${id}</div>
        <div>État : <b>${state.toUpperCase()}</b></div>
        <div class="smallInfo">Purifications : ${purifyCount}/4</div>
        ${
          state === "contamine" && contaminatedSince
          ? `<div class="smallInfo">Contaminé depuis : ${msToMin(Date.now() - contaminatedSince)} min</div>`
          : ""
        }
      `;

      container.appendChild(div);
    }

  } catch (err) {
    console.error("Erreur dashboard :", err);
  }
}

// actualisation toutes les 3 sec
load();
setInterval(load, 3000);
</script>

</body>
</html>
